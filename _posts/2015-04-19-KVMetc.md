---
layout: post
title: KVMでごにょごにょ
---
 * LinuxMint17の仮想マシンをひとつ起こした。用途はまぁあれだ。
 * いつも仮想マシンを起こす際に悩むのはそのディスク容量。将来的なことを考えて大きめに確保しがちなのだが、今回はギリギリまで攻めて10GBとした。
 * その代わりといってはなんだが、VirtFSを使ってホストOS側の領域を使うことにした（順番としてはこっちにするから10GBにした）。
 * が、思ったよりも詰まった。結論としてはqemu.conf内でuser="root"とgroup="root"とすることで解決できたのだが、clear_emulator_capabilities = 0にしたり、対象ディレクトリのパーミッションを777にしたりと色々寄り道した。
 * あとはモジュールを読み込むまではmountできないので遅延mountとして、/etc/fstabのoptionの項目に_netfsを追加した。
 
 ```
 home /home/mix4o 9p _netdev,trans=virtio,version=9p2000.L      0 2
 ```

 * 厳密にはネットワークではないので_netfs扱いが最適とは言えないが、ほかに適当な遅延の仕組みがなかったのでこれで。
 * あとはAndroid端末からリモートで仮想マシンにアクセスしようとしたが、2つのVNCクライアントアプリが両方ともまともに接続できなくてこのアプローチは断念。IPsec/VPNで家のネットワークに入り込む形で動作しないんじゃ話にならない。なお、VPN張った状態でSSHクライアントは正しく動くのでVPNの問題ではない。
 * 仕方ないのでAndroidで比較的安定して動いているという理由からTeamViewerをホストOS側にいれる。debパッケージは用意されているが、依存関係が手動で解決するにはいろいろ面倒。
 * 調べてみるとUbuntuだとgdebiというプログラムでローカルのdebの依存関係を解決してインストールしてくれるっぽい。そりゃ便利だ。
 * これでTeamViewer経由でGUIアクセスはできるところまできた。
 * この状況でKVMのクライアント(CPU2つ割りあて）でCPU負荷をかけ、ホストOS側でi7zを実行してCPUの省電力状況を確認してみた。
 * 本当に何もしていない時はCPUクロックが下がってC3やC6の比率はほぼない状況だったが、ゲスト側で負荷をかけるとCPUクロックはあがったままでC3やC6の比率がかなりあがっていた。
 * つまり省電力機構としてはクロックを下げられる時は下げて、その場合は相対的にC3やC6に移行することが少なくなり、仕事量が多くてクロックが下げられない時はC3やC6へ移行することで細かく省電力を試みるという挙動のようだ。
 * その結果どの程度電力消費してるか（軽減できているか）はさっぱりわからないんだけどね！
 * しかしこの結果からみるとCore-i5 4690SでTDP65Wまで許容したのは正解だったと言えそう。もしTDP35W狙いでクロックを1.9GHz(TB2.7GHz)の4460Tにしていたら、1VM負荷をかけただけで性能に余裕がなくなっていた可能性が高い。
 
